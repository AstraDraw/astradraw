# Invite Links System

This document describes how workspace invite links work in AstraDraw.

## Overview

Invite links allow workspace admins to share a URL that enables new users to join their workspace. The system supports:

- One-click joining for authenticated users
- Login/registration flow for unauthenticated users
- Configurable expiration and usage limits
- Role assignment (ADMIN, MEMBER, VIEWER)

## User Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    User visits /invite/CODE                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Authenticated? │
                    └─────────────────┘
                      │           │
                     No          Yes
                      │           │
                      ▼           ▼
            ┌─────────────┐  ┌─────────────────┐
            │ Show Login  │  │ Call Join API   │
            │   Dialog    │  │ POST /join      │
            └─────────────┘  └─────────────────┘
                  │                   │
                  │           ┌──────┴──────┐
                  │           │             │
                  ▼        Success        Error
            User logs in      │             │
                  │           ▼             ▼
                  │    ┌───────────┐  ┌───────────┐
                  └───►│ Navigate  │  │ Show Error│
                       │ to Dash   │  │  Message  │
                       └───────────┘  └───────────┘
```

## URL Format

```
https://<domain>/invite/<code>
```

Example:
```
https://10.100.0.10/invite/29hoh7y4b8
```

The code is a unique alphanumeric string generated by the backend.

## API Endpoints

### Create Invite Link (Admin only)

```http
POST /api/v2/workspaces/:workspaceId/invite-links
Content-Type: application/json

{
  "role": "MEMBER",           // Optional: ADMIN, MEMBER, VIEWER (default: MEMBER)
  "expiresAt": "2025-01-01",  // Optional: ISO date string
  "maxUses": 10               // Optional: maximum number of uses
}
```

Response:
```json
{
  "id": "clxyz123",
  "code": "29hoh7y4b8",
  "role": "MEMBER",
  "workspaceId": "clwxyz789",
  "expiresAt": "2025-01-01T00:00:00.000Z",
  "maxUses": 10,
  "uses": 0,
  "createdAt": "2024-12-21T10:00:00.000Z"
}
```

### List Invite Links (Admin only)

```http
GET /api/v2/workspaces/:workspaceId/invite-links
```

### Delete Invite Link (Admin only)

```http
DELETE /api/v2/workspaces/:workspaceId/invite-links/:linkId
```

### Join via Invite Link

```http
POST /api/v2/workspaces/join
Content-Type: application/json

{
  "code": "29hoh7y4b8"
}
```

Response (success):
```json
{
  "id": "clwxyz789",
  "name": "My Workspace",
  "slug": "my-workspace",
  "role": "MEMBER",
  "memberCount": 5,
  ...
}
```

Error responses:
- `401 Unauthorized` - User not authenticated
- `404 Not Found` - Invalid invite code
- `400 Bad Request` - Link expired or max uses reached

## Frontend Implementation

### Files

| File | Purpose |
|------|---------|
| `App.tsx` | URL pattern detection, renders InviteAcceptPage |
| `InviteAcceptPage.tsx` | Main invite acceptance component |
| `InviteAcceptPage.scss` | Styles with dark mode support |
| `workspaceApi.ts` | `joinViaInviteLink()` API function |

### URL Detection

In `App.tsx`, the invite URL pattern is detected on initial load:

```typescript
const INVITE_URL_PATTERN = /^\/invite\/([a-zA-Z0-9_-]+)$/;

const [pendingInviteCode, setPendingInviteCode] = useState<string | null>(() => {
  const match = window.location.pathname.match(INVITE_URL_PATTERN);
  return match ? match[1] : null;
});
```

### Component States

The `InviteAcceptPage` component handles several states:

1. **Loading** - Checking authentication status
2. **Unauthenticated** - Shows login dialog with invite context
3. **Joining** - API call in progress
4. **Error** - Shows error message with retry option
5. **Success** - Redirects to workspace dashboard

### API Client

```typescript
// frontend/excalidraw-app/auth/workspaceApi.ts

export async function joinViaInviteLink(code: string): Promise<Workspace> {
  const response = await fetch(`${getApiBaseUrl()}/workspaces/join`, {
    method: "POST",
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ code }),
  });

  if (!response.ok) {
    if (response.status === 401) {
      throw new Error("Not authenticated");
    }
    if (response.status === 404) {
      throw new Error("Invalid invite link");
    }
    if (response.status === 400) {
      throw new Error("Invite link expired or reached max uses");
    }
    throw new Error("Failed to join workspace");
  }

  return response.json();
}
```

## Backend Implementation

### Database Schema

```prisma
model InviteLink {
  id          String    @id @default(cuid())
  code        String    @unique
  role        Role      @default(MEMBER)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  expiresAt   DateTime?
  maxUses     Int?
  uses        Int       @default(0)
  createdAt   DateTime  @default(now())
}
```

### Join Logic

When a user joins via invite link:

1. Validate the invite code exists
2. Check expiration date (if set)
3. Check usage count against max uses (if set)
4. Create workspace membership with specified role
5. Increment the `uses` counter
6. Return the workspace data

## Creating Invite Links (Admin UI)

Workspace admins can create invite links from the Members page:

1. Navigate to **Settings → Members**
2. Click **Invite Link** button
3. Select role for new members
4. Copy the generated link
5. Share with invitees

The link expires after 7 days by default.

## Translations

English (`en.json`):
```json
"workspace": {
  "invite": {
    "joiningWorkspace": "Joining workspace...",
    "loginToJoin": "Sign in to join workspace",
    "loginDescription": "You've been invited to join a workspace. Please sign in or create an account to continue.",
    "invalidLink": "This invite link is invalid or has expired",
    "alreadyMember": "You are already a member of this workspace",
    "joinSuccess": "Successfully joined workspace!",
    "error": "Failed to join workspace",
    "errorTitle": "Unable to join",
    "tryAgain": "Try again",
    "goHome": "Go to home",
    "cancel": "Cancel"
  }
}
```

Russian (`ru-RU.json`):
```json
"workspace": {
  "invite": {
    "joiningWorkspace": "Присоединение к пространству...",
    "loginToJoin": "Войдите, чтобы присоединиться",
    "loginDescription": "Вас пригласили в рабочее пространство. Войдите или создайте аккаунт, чтобы продолжить.",
    "invalidLink": "Эта ссылка недействительна или срок её действия истёк",
    "alreadyMember": "Вы уже являетесь участником этого пространства",
    "joinSuccess": "Вы успешно присоединились!",
    "error": "Не удалось присоединиться",
    "errorTitle": "Не удалось присоединиться",
    "tryAgain": "Попробовать снова",
    "goHome": "На главную",
    "cancel": "Отмена"
  }
}
```

## Error Handling

| Error | User Message | Cause |
|-------|--------------|-------|
| 401 | Redirect to login | User not authenticated |
| 404 | "Invalid or expired link" | Code doesn't exist |
| 400 | "Invalid or expired link" | Expired or max uses reached |
| 409 | "Already a member" | User already in workspace |

## Security Considerations

1. **Invite codes** are randomly generated and unguessable
2. **Expiration** limits the window of vulnerability
3. **Max uses** prevents unlimited sharing
4. **Authentication required** before joining
5. **Admin-only creation** restricts who can invite
6. **Audit trail** via `uses` counter

## Nginx SPA Routing

### The Problem

When a user visits `/invite/CODE` directly (e.g., by clicking a shared link), the browser makes a request to the server for that exact path. By default, nginx looks for a file at that path and returns 404 when it doesn't exist.

This is a common challenge with Single-Page Applications (SPAs) like React:
- The routing logic lives in JavaScript (client-side)
- The server must serve `index.html` for all frontend routes
- Once loaded, React Router handles the URL and renders the appropriate component

### The Solution

A custom nginx configuration (`nginx.conf`) was added to handle SPA routing:

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

This directive tells nginx:
1. First, try to serve the exact file requested (`$uri`)
2. If not found, try it as a directory (`$uri/`)
3. If still not found, serve `index.html` — allowing React to handle the route

### Files Modified

| File | Change |
|------|--------|
| `frontend/nginx.conf` | New nginx config with SPA fallback routing |
| `frontend/Dockerfile` | Added `COPY nginx.conf` to include config in image |
| `frontend/.dockerignore` | Added `!nginx.conf` to include file in build context |

### Routes Handled

The SPA routing enables these client-side routes:
- `/invite/:code` — Invite link acceptance
- `/workspace/:slug/scene/:id` — Direct scene links
- Any future frontend routes

## Future Improvements

### Short-term

1. **Invite Link Preview**
   - Show workspace name and inviter info before joining
   - Requires a public API endpoint to fetch invite metadata

2. **Email Invitations**
   - Send invite links via email directly from the UI
   - Include workspace branding in email template

3. **Invite Link Management UI**
   - View all active invite links
   - See usage statistics (uses vs max uses)
   - Revoke links individually

### Medium-term

4. **Role Selection for Invitees**
   - Allow admins to create links for specific roles
   - VIEWER links for read-only access
   - MEMBER links for standard access
   - ADMIN links (with extra confirmation)

5. **Team-specific Invites**
   - Invite users directly into a team
   - Auto-assign team membership on join

6. **Invite Notifications**
   - Notify workspace admins when someone joins
   - Activity log for invite link usage

### Long-term

7. **Domain-restricted Invites**
   - Only allow users from specific email domains
   - Useful for enterprise deployments

8. **Approval Workflow**
   - Require admin approval before joining
   - Queue pending join requests

9. **SSO-integrated Invites**
   - Auto-join workspace based on OIDC groups
   - Map OIDC roles to workspace roles

## Related Documentation

- [Workspace System](./WORKSPACE.md) - Workspace management
- [Collaboration](./COLLABORATION.md) - Real-time collaboration
- [Architecture](./ARCHITECTURE.md) - System architecture

