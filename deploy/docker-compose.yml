# Astradraw - Self-hosted Excalidraw with Collaboration
# 
# This docker-compose file sets up:
# - Excalidraw frontend (built from source)
# - Excalidraw room server (WebSocket for collaboration)
# - Storage backend (HTTP API for persistence)
# - MinIO (S3-compatible object storage) OR PostgreSQL (via Keyv)
# - Traefik proxy (for single-domain routing)
#
# Storage Options:
#   - S3/MinIO (default): Set STORAGE_BACKEND=s3 (recommended for blobs)
#   - Keyv/PostgreSQL: Set STORAGE_BACKEND=keyv (legacy, for small deployments)
#
# Usage:
#   1. cd deploy/
#   2. Copy env.example to .env and configure
#   3. Create secrets: see secrets/ directory
#   4. Run: docker compose up -d

services:
  # Traefik reverse proxy
  traefik:
    image: traefik:v3.0
    command:
      - "--api.dashboard=true"
      # Uncomment for debugging:
      # - "--api.insecure=true"
      # - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Uncomment for automatic HTTPS with Let's Encrypt
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      # Uncomment for Traefik dashboard:
      # - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./traefik-dynamic.yml:/etc/traefik/dynamic/config.yml:ro
      # - ./letsencrypt:/letsencrypt
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # Dashboard (optional, uncomment to enable)
      # - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${APP_DOMAIN}`)"
      # - "traefik.http.routers.traefik-dashboard.service=api@internal"

  # Excalidraw Frontend
  app:
    # For production: use pre-built image from GitHub Container Registry
    image: ghcr.io/astrateam-net/astradraw-app:0.18.0-beta0.43
    # For development: override in docker-compose.override.yml
    restart: unless-stopped
    environment:
      # Use http:// for local testing, https:// for production with SSL
      - VITE_APP_WS_SERVER_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}
      - VITE_APP_BACKEND_V2_GET_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2/scenes/
      - VITE_APP_BACKEND_V2_POST_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2/scenes/
      - VITE_APP_STORAGE_BACKEND=http
      - VITE_APP_HTTP_STORAGE_BACKEND_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2
      - VITE_APP_FIREBASE_CONFIG=
      - VITE_APP_DISABLE_TRACKING=true
      # GIPHY API key for Stickers & GIFs sidebar (get one at https://developers.giphy.com/)
      - VITE_APP_GIPHY_API_KEY=${GIPHY_API_KEY:-}
      # Note: Kinescope API keys are configured in the storage backend service for security
      # The frontend automatically uses the proxy at VITE_APP_HTTP_STORAGE_BACKEND_URL
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # HTTP (redirect to HTTPS)
      - "traefik.http.routers.excalidraw-app.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.excalidraw-app.entrypoints=web"
      - "traefik.http.routers.excalidraw-app.middlewares=redirect-to-https"
      # HTTPS
      - "traefik.http.routers.excalidraw-app-secure.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.excalidraw-app-secure.entrypoints=websecure"
      - "traefik.http.routers.excalidraw-app-secure.tls=true"
      - "traefik.http.services.excalidraw-app.loadbalancer.server.port=80"
      # Redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.excalidraw-app.priority=1"
      - "traefik.http.routers.excalidraw-app-secure.priority=1"
    depends_on:
      - api
      - room

  # AstraDraw Room Server (WebSocket collaboration)
  room:
    image: ghcr.io/astrateam-net/astradraw-room:latest
    # For development: override in docker-compose.override.yml
    restart: unless-stopped
    environment:
      - PORT=80
      - CORS_ORIGIN=*
      - DEBUG=*
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # WebSocket routing via /socket.io/ path (HTTPS)
      - "traefik.http.routers.astradraw-room-secure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.astradraw-room-secure.entrypoints=websecure"
      - "traefik.http.routers.astradraw-room-secure.tls=true"
      - "traefik.http.routers.astradraw-room-secure.priority=100"
      - "traefik.http.services.astradraw-room.loadbalancer.server.port=80"
      # WebSocket routing via /socket.io/ path (HTTP -> HTTPS)
      - "traefik.http.routers.astradraw-room.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.astradraw-room.entrypoints=web"
      - "traefik.http.routers.astradraw-room.middlewares=redirect-to-https"
      - "traefik.http.routers.astradraw-room.priority=100"

  # AstraDraw API (authentication, workspace, storage)
  api:
    # For production: use pre-built image from GitHub Container Registry
    image: ghcr.io/astrateam-net/astradraw-api:0.6.0
    # For development: override in docker-compose.override.yml
    restart: unless-stopped
    environment:
      # Storage backend selection: 's3' (MinIO/S3) or 'keyv' (PostgreSQL/MongoDB)
      - STORAGE_BACKEND=${STORAGE_BACKEND:-s3}
      
      # === S3/MinIO Configuration (when STORAGE_BACKEND=s3) ===
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY_FILE=/run/secrets/minio_access_key
      - S3_SECRET_KEY_FILE=/run/secrets/minio_secret_key
      - S3_BUCKET=${S3_BUCKET:-excalidraw}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_FORCE_PATH_STYLE=true
      
      # === Keyv Configuration (when STORAGE_BACKEND=keyv) ===
      # - STORAGE_URI_FILE=/run/secrets/storage_uri
      # - STORAGE_URI=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      
      # === PostgreSQL Configuration (for Workspace/User management) ===
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public
      
      # === OIDC Configuration (Authentik) ===
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_CALLBACK_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2/auth/callback
      # Internal URL for OIDC discovery (uses Docker network, bypasses Traefik/SSL)
      - OIDC_INTERNAL_URL=${OIDC_INTERNAL_URL:-}
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - APP_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}
      
      # === Local Authentication (Default Admin) ===
      - ENABLE_LOCAL_AUTH=${ENABLE_LOCAL_AUTH:-true}
      - ENABLE_REGISTRATION=${ENABLE_REGISTRATION:-true}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@localhost}
      
      # === Super Admin Configuration ===
      # Comma-separated list of emails that should be super admins
      - SUPERADMIN_EMAILS=${SUPERADMIN_EMAILS:-admin@localhost}
      
      # === Kinescope Configuration (for Talktrack video proxy) ===
      - KINESCOPE_API_KEY=${KINESCOPE_API_KEY:-}
      - KINESCOPE_PROJECT_ID=${KINESCOPE_PROJECT_ID:-}
      
      - PORT=8080
      - LOG_LEVEL=log  # Set to 'log' to see secret loading messages
    volumes:
      - ./secrets:/run/secrets:ro
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      # API routing via /api/v2/ path (HTTPS)
      - "traefik.http.routers.astradraw-api-secure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/v2`)"
      - "traefik.http.routers.astradraw-api-secure.entrypoints=websecure"
      - "traefik.http.routers.astradraw-api-secure.tls=true"
      - "traefik.http.routers.astradraw-api-secure.priority=100"
      - "traefik.http.services.astradraw-api.loadbalancer.server.port=8080"
      # API routing via /api/v2/ path (HTTP -> HTTPS)
      - "traefik.http.routers.astradraw-api.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/v2`)"
      - "traefik.http.routers.astradraw-api.entrypoints=web"
      - "traefik.http.routers.astradraw-api.middlewares=redirect-to-https"
      - "traefik.http.routers.astradraw-api.priority=100"
      # Note: Don't strip prefix - API already expects /api/v2 routes
    extra_hosts:
      # Allow API to reach Dex via external hostname (for OIDC discovery)
      - "auth.${APP_DOMAIN}:host-gateway"
    depends_on:
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # MinIO - S3-compatible Object Storage (recommended for blob storage)
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      - MINIO_ROOT_USER_FILE=/run/secrets/minio_access_key
      - MINIO_ROOT_PASSWORD_FILE=/run/secrets/minio_secret_key
    volumes:
      - minio_data:/data
      - ./secrets:/run/secrets:ro
    networks:
      - internal
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Console (Object Storage Admin UI - Optional)
  minio-console:
    image: minio/minio:latest
    entrypoint: [""]
    command: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-console-secure.rule=Host(`s3.${APP_DOMAIN}`)"
      - "traefik.http.routers.minio-console-secure.entrypoints=websecure"
      - "traefik.http.routers.minio-console-secure.tls=true"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      - "traefik.http.routers.minio-console-secure.service=minio-console-backend"
      - "traefik.http.services.minio-console-backend.loadbalancer.server.url=http://minio:9001"
    depends_on:
      - minio
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

  # PostgreSQL Database (recommended for production)
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin (Database Admin UI - Optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
      - PGADMIN_CONFIG_SERVER_MODE=False
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin-secure.rule=Host(`db.${APP_DOMAIN}`)"
      - "traefik.http.routers.pgadmin-secure.entrypoints=websecure"
      - "traefik.http.routers.pgadmin-secure.tls=true"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
    depends_on:
      - postgres
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

  # Dex - Lightweight OIDC Provider for Testing
  # Start with: docker-compose --profile oidc up
  dex:
    image: ghcr.io/dexidp/dex:v2.38.0
    restart: unless-stopped
    command: ["dex", "serve", "/etc/dex/config.yaml"]
    volumes:
      - ./dex-config.yaml:/etc/dex/config.yaml:ro
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # HTTPS routing for Dex
      - "traefik.http.routers.dex-secure.rule=Host(`auth.${APP_DOMAIN}`)"
      - "traefik.http.routers.dex-secure.entrypoints=websecure"
      - "traefik.http.routers.dex-secure.tls=true"
      - "traefik.http.services.dex.loadbalancer.server.port=5556"
      # HTTP redirect
      - "traefik.http.routers.dex.rule=Host(`auth.${APP_DOMAIN}`)"
      - "traefik.http.routers.dex.entrypoints=web"
      - "traefik.http.routers.dex.middlewares=redirect-to-https"
    profiles:
      - oidc  # Only start with: docker-compose --profile oidc up

networks:
  astradraw:
    driver: bridge
  internal:
    driver: bridge
    internal: true

volumes:
  postgres_data:
  pgadmin_data:
  minio_data:

