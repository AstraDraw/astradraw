# Traefik dynamic configuration for Native Development (just dev)
#
# Used by docker-compose.infra.yml when running native services.
# Routes requests to native services running on the host machine:
# - Frontend (Vite): host.docker.internal:3000
# - Backend (NestJS): host.docker.internal:8080
# - Room (Socket.io): host.docker.internal:3002
# - MinIO: stays in Docker network (minio:9000)

# TLS Configuration (self-signed certs)
tls:
  certificates:
    - certFile: /etc/traefik/certs/server.crt
      keyFile: /etc/traefik/certs/server.key
  stores:
    default:
      defaultCertificate:
        certFile: /etc/traefik/certs/server.crt
        keyFile: /etc/traefik/certs/server.key

# HTTP Configuration
http:
  # Routers - define how requests are matched and routed
  routers:
    # Frontend (Vite dev server) - lowest priority, catch-all
    frontend:
      rule: "HostRegexp(`.*`)"
      entryPoints:
        - websecure
      service: frontend
      tls: {}
      priority: 1

    frontend-http:
      rule: "HostRegexp(`.*`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: frontend
      priority: 1

    # Backend API - /api/v2 path
    api:
      rule: "PathPrefix(`/api/v2`)"
      entryPoints:
        - websecure
      service: api
      tls: {}
      priority: 100

    api-http:
      rule: "PathPrefix(`/api/v2`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: api
      priority: 100

    # Room service (WebSocket) - /socket.io path
    room:
      rule: "PathPrefix(`/socket.io`)"
      entryPoints:
        - websecure
      service: room
      tls: {}
      priority: 100

    room-http:
      rule: "PathPrefix(`/socket.io`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: room
      priority: 100

    # MinIO S3 API - /s3 path (stays in Docker)
    minio-s3:
      rule: "PathPrefix(`/s3`)"
      entryPoints:
        - websecure
      service: minio
      middlewares:
        - strip-s3-prefix
      tls: {}
      priority: 110

    minio-s3-http:
      rule: "PathPrefix(`/s3`)"
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
      service: minio
      priority: 110

  # Services - define where requests are forwarded
  services:
    # Frontend - Vite dev server on host (port 3000)
    frontend:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3000"

    # Backend API - NestJS on host
    api:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:8081"

    # Room service - Socket.io on host
    room:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3002"

    # MinIO - stays in Docker network
    minio:
      loadBalancer:
        servers:
          - url: "http://minio:9000"

  # Middlewares
  middlewares:
    # Redirect HTTP to HTTPS
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Strip /s3 prefix for MinIO
    strip-s3-prefix:
      stripPrefix:
        prefixes:
          - "/s3"

