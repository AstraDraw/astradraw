---
description: "Development environment and Docker issues for AstraDraw"
globs: ["deploy/**/*", "docker-compose*.yml", "Dockerfile", "**/Dockerfile", "Justfile"]
---

# Development & Docker Issues

## ðŸš¨ CRITICAL: Use `just dev` for Daily Development

**Problem:** Using `just up-dev` for features causes slow iteration.

**Why it's wrong:** Docker builds take 1-5 minutes per change.

**Solution:**
```bash
just dev          # Start with hot-reload
just dev-status   # Check status
just dev-stop     # Stop when done
```

**Benefits of `just dev`:**
- CSS changes appear instantly
- React changes hot-reload in ~100ms
- Backend auto-restarts on changes

**When to use Docker (`just up-dev`):**
- Testing Dockerfile changes
- Pre-release verification

## "Bad Gateway" at https://draw.local

**Cause:** Native services not running.

**Solution:**
```bash
just dev-status   # See what's running
just dev          # Start fresh
```

## Changes Not Appearing (Hot-Reload)

**Checklist:**
1. Is `just dev` running? Check with `just dev-status`
2. Are you accessing `https://draw.local`?
3. Try hard refresh: `Cmd+Shift+R`
4. Check terminal for errors

### Backend Changes Not Appearing

**Problem:** Backend code changes aren't being picked up even with `just dev` running.

**Symptoms:**
- New log statements don't appear
- New endpoints return 404
- Service injection changes don't take effect

**Solution:**
```bash
# Option 1: Restart backend only
just dev-restart-backend

# Option 2: Full restart (if Option 1 doesn't work)
just dev-stop && just dev
```

**Why this happens:** NestJS watch mode sometimes misses changes, especially:
- Module imports/exports changes
- New service injections
- Changes to providers array

## Port Already in Use

**Solution:**
```bash
just dev-stop     # Stops all services

# Or manually:
lsof -ti:3000 | xargs kill -9  # Frontend
lsof -ti:8080 | xargs kill -9  # Backend
```

## Authentication Not Working in Dev

**Cause:** Accessing via `localhost:3000` instead of `https://draw.local`.

**Solution:** Always use `https://draw.local`

## "draw.local" Not Accessible

**Cause:** Missing `/etc/hosts` entry.

**Solution:**
```bash
# macOS/Linux
sudo sh -c 'echo "127.0.0.1 draw.local" >> /etc/hosts'
```

## ðŸš¨ Docker Build Cache Issues

**Problem:** Code changes don't appear after rebuild.

**Symptoms:**
- `CACHED` next to build steps in Docker output
- Event handlers don't fire
- New features don't appear

**Solution:**
```bash
just rebuild app        # Rebuild without cache
just build-no-cache     # Rebuild all without cache
```

**When to use `--no-cache`:**
- After code changes that aren't appearing
- After switching git branches
- When Docker shows `CACHED` on build step

## SSL Certificate Invalid

**Solution:** Accept the certificate in browser, or use Let's Encrypt for production.

## Test Users (Development)

After running `just db-seed` or `just dev-fresh`:

| User | Email | Password | Role in Acme Corp |
|------|-------|----------|-------------------|
| Super Admin | `admin@localhost` | `admin` | (system admin) |
| Alice | `alice@test.local` | `Test123!` | ADMIN |
| Bob | `bob@test.local` | `Test123!` | MEMBER (EDIT Engineering) |
| Carol | `carol@test.local` | `Test123!` | MEMBER (EDIT Design) |
| Dave | `dave@test.local` | `Test123!` | VIEWER |
| Eve | `eve@test.local` | `Test123!` | (not a member) |

See `/docs/development/TEST_USERS.md` for full scenarios.

## Testing Backend API with curl

When testing backend changes, use curl with proper authentication:

```bash
# Login and save cookies
curl -X POST "https://draw.local/api/v2/auth/login/local" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin@localhost","password":"admin"}' \
  -k -c /tmp/cookies.txt -s | jq .

# Make authenticated requests
curl -X GET "https://draw.local/api/v2/notifications/unread-count" \
  -k -b /tmp/cookies.txt -s | jq .

# POST with JSON body (replace SCENE_ID and USER_ID with actual values)
curl -X POST "https://draw.local/api/v2/scenes/<SCENE_ID>/threads" \
  -H "Content-Type: application/json" \
  -d '{"x": 100, "y": 100, "content": "Test comment", "mentions": ["<USER_ID>"]}' \
  -k -b /tmp/cookies.txt -s | jq .
```

**Flags explained:**
- `-k` - Skip SSL verification (for self-signed certs)
- `-c /tmp/cookies.txt` - Save cookies to file
- `-b /tmp/cookies.txt` - Send cookies from file
- `-s` - Silent mode (no progress bar)
- `| jq .` - Pretty-print JSON response

## Quick Database Queries

Use `docker exec` to run quick PostgreSQL queries:

```bash
# List users
docker exec deploy-postgres-1 psql -U excalidraw -d excalidraw \
  -c "SELECT id, email, name FROM users;"

# Check notifications
docker exec deploy-postgres-1 psql -U excalidraw -d excalidraw \
  -c "SELECT id, type, \"userId\", read FROM notifications;"

# Check workspace membership
docker exec deploy-postgres-1 psql -U excalidraw -d excalidraw \
  -c "SELECT u.name, wm.role, w.name as workspace FROM workspace_members wm JOIN users u ON wm.\"userId\" = u.id JOIN workspaces w ON wm.\"workspaceId\" = w.id;"
```

## Update User Password (for testing)

When you need to test with a specific user but don't know their password:

```bash
cd backend && node -e "
const bcrypt = require('bcryptjs');
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function updatePassword() {
  const hash = await bcrypt.hash('NewPassword123!', 10);
  await prisma.user.update({
    where: { id: '<USER_ID>' },  // Replace with actual user ID
    data: { passwordHash: hash }
  });
  console.log('Password updated');
  await prisma.\\\$disconnect();
}

updatePassword().catch(console.error);
"
```

**Note:** Database must be running (`just dev` or Docker containers up).

## Release Process Issues

### Tag Already Exists

```bash
git tag -f v0.5.2
git push origin v0.5.2 --force
```

### GitHub Actions Build Fails

**Check:**
1. Run local build first: `npm run build`
2. Check for missing dependencies
3. Verify import paths
4. Ensure all translation keys exist
