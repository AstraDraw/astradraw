---
description: "AstraDraw project overview - minimal context for all chats"
alwaysApply: true
---

# AstraDraw Project Overview

AstraDraw is a self-hosted Excalidraw fork with enterprise features: user authentication (OIDC/local), workspaces, collaboration, video recordings (Talktrack), and presentation mode.

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React, Vite, TypeScript, Jotai |
| Backend | NestJS, Prisma, PostgreSQL |
| Storage | S3/MinIO via `IStorageService` abstraction |
| Realtime | Socket.io room server |
| Routing | Traefik (HTTPS, path-based, sticky sessions) |
| Auth | JWT in HTTP-only cookies, OIDC support |
| Infrastructure | Docker, secrets via `_FILE` env pattern |

**Important:** `frontend/`, `backend/`, `room-service/` are separate git repositories.

## Excalidraw Fork Ownership

**CRITICAL:** `frontend/packages/excalidraw/` is AstraDraw's fully controlled fork. This is NOT an external dependency.

- âœ… We OWN and CONTROL all code in `packages/excalidraw/`
- âœ… We can modify ANY file in this directory
- âœ… We will NEVER merge upstream Excalidraw changes
- âœ… This is LOCAL code in our monorepo, not from npm

### How It Works

When you see imports like `import { MainMenu } from "@excalidraw/excalidraw/index"`:

```
@excalidraw/excalidraw â†’ frontend/packages/excalidraw/ (LOCAL)
           â†‘
    NOT from npm/node_modules
```

**Yarn Workspaces** creates symlinks in `node_modules/@excalidraw/*` â†’ `packages/*`

**Vite aliases** resolve imports directly to `packages/excalidraw/` source files

**Build process** bundles YOUR local files from `packages/excalidraw/`

### Decision Pattern

When implementing features that touch Excalidraw functionality:

**ASK:** Is this a core Excalidraw UI/behavior change?
- âœ… **YES** â†’ Modify `packages/excalidraw/` source code directly
- âŒ **NO** â†’ Implement in `excalidraw-app/` (AstraDraw-specific layer)

### Examples

| Component Type | Where to Modify |
|---|---|
| Main menu items | `packages/excalidraw/components/main-menu/` |
| Default UI behavior | `packages/excalidraw/components/` |
| Core actions | `packages/excalidraw/actions/` |
| App state/types | `packages/excalidraw/types.ts` |

| Feature Type | Where to Implement |
|---|---|
| Auth integration | `excalidraw-app/auth/` |
| Workspace features | `excalidraw-app/components/` |
| Backend API calls | `excalidraw-app/auth/api/` |

### Case Studies (Real Examples)

**Good: Sidebar tabs** - `AppSidebar.tsx` uses `DefaultSidebar.TabTriggers` tunnel API to inject Comments, Stickers, Talktrack tabs. Correct approach - uses Excalidraw's composition API.

**Good: Custom pens** - Added `customPens` to `AppState` in `packages/excalidraw/types.ts`, UI in `excalidraw-app/pens/`. Correct - extended core types, app-specific UI.

**Improvable: Comment markers** - `ThreadMarkersLayer` renders DOM overlay, manually tracks pan/zoom. Could render on canvas like collaborator cursors in `clients.ts`.

**Improvable: excalidrawAPI prop drilling** - 155 uses across 20 files. Components receive API just to call `getAppState()`. Could export hooks from `packages/excalidraw/`.

**Full documentation:** [/docs/architecture/FORK_ARCHITECTURE.md](/docs/architecture/FORK_ARCHITECTURE.md)

### Anti-Patterns to Avoid

ðŸš© Importing internal Excalidraw hooks in `excalidraw-app/` (e.g., `useExcalidrawActionManager`)

ðŸš© Passing `excalidrawAPI` through many prop layers to bypass encapsulation

ðŸš© Using `updateScene()` to work around missing features

ðŸš© Thinking "I can't change this because it's from Excalidraw"

**Mindset:** Stop thinking "How to work AROUND Excalidraw?" Start thinking "How to IMPROVE Excalidraw source?"

## Documentation

**Start here:** `/docs/README.md` - Full documentation index.

| Category | Path |
|----------|------|
| Getting Started | `/docs/getting-started/` |
| Architecture | `/docs/architecture/` |
| Features | `/docs/features/` |
| Deployment | `/docs/deployment/` |
| Guides | `/docs/guides/` |
| Troubleshooting | `/docs/troubleshooting/` |
| Planning | `/docs/planning/` |

## Key Invariants

### Authentication
- JWT stored only in HTTP-only cookies (never localStorage)
- OIDC user linking: match by OIDC ID â†’ fallback to email â†’ create new

### Data Model
- Each new user gets a default PERSONAL workspace (ADMIN role)
- Workspace types: PERSONAL (no collaboration) vs SHARED (full collaboration)
- Role hierarchy: ADMIN > MEMBER > VIEWER

### Infrastructure
- Traefik routes: `/` â†’ frontend, `/socket.io` â†’ room, `/api` â†’ backend
- Use `getSecret()` / `getSecretOrThrow()` for Docker secrets
- HTTPS required in production (Web Crypto API needs secure context)

## Quick Start

```bash
just dev          # Start with hot-reload
just dev-status   # Check status
just check    # Run all checks
```

Access: `https://draw.local`
