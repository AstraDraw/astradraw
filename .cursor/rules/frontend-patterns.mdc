---
description: "Frontend development patterns for AstraDraw (React/Excalidraw)"
globs: ["frontend/**/*.ts", "frontend/**/*.tsx", "frontend/**/*.scss", "frontend/**/*.css"]
---

# Frontend Development Patterns

**Related rules:**
- For state management details, see @frontend-state
- For common issues, see @common-issues-frontend

## Project Structure

```
frontend/
├── excalidraw-app/           # AstraDraw-specific code
│   ├── auth/                 # Authentication
│   │   ├── api/              # Modular API client (scenes, workspaces, etc.)
│   │   ├── AuthContext.tsx   # Auth provider
│   │   └── workspaceApi.ts   # Re-exports from api/ (backward compat)
│   ├── lib/                  # Shared utilities
│   │   └── queryClient.ts    # React Query client + query keys
│   ├── hooks/                # Extracted logic hooks
│   │   ├── useAutoSave.ts    # Save state machine, debounce, retry
│   │   ├── useSceneLoader.ts # Scene loading, auto-collab
│   │   ├── useUrlRouting.ts  # Popstate, URL parsing
│   │   ├── useKeyboardShortcuts.ts  # Global keyboard handlers
│   │   ├── useWorkspaces.ts  # Workspace loading (React Query + Jotai)
│   │   ├── useCollections.ts # Collection CRUD (React Query + Jotai)
│   │   ├── useScenesCache.ts # Scene fetching (React Query)
│   │   └── useSceneActions.ts # Scene CRUD with optimistic updates
│   ├── components/           # Custom components
│   │   ├── Workspace/        # Sidebar, SceneCard, LoginDialog
│   │   ├── Settings/         # ProfilePage, MembersPage, settingsState.ts
│   │   ├── EmojiPicker/      # Emoji picker for collection icons
│   │   ├── Talktrack/        # Recording feature
│   │   └── Presentation/     # Slideshow mode
│   └── App.tsx               # Main app orchestrator (uses hooks)
├── packages/excalidraw/      # Core Excalidraw library
│   ├── locales/              # Translation files (en.json, ru-RU.json)
```

## App Mode & Navigation

| Mode | `appModeAtom` | What's Displayed |
|------|---------------|------------------|
| Dashboard | `"dashboard"` | Dashboard, Collections, Settings |
| Canvas | `"canvas"` | Excalidraw drawing canvas |

### URL Patterns

- Dashboard: `/workspace/{slug}/dashboard`
- Collection: `/workspace/{slug}/collection/{id}`
- Scene: `/workspace/{slug}/scene/{id}`
- Settings: `/workspace/{slug}/settings`
- Profile: `/profile`

### Navigation Atoms

```typescript
import {
  navigateToCanvasAtom,
  navigateToDashboardAtom,
  navigateToCollectionAtom,
  navigateToSceneAtom,
} from "./components/Settings/settingsState";

const navigateToScene = useSetAtom(navigateToSceneAtom);
navigateToScene({ workspaceSlug, sceneId, title });
```

**See:** `/docs/architecture/URL_ROUTING.md` for full documentation.

## CSS Hide/Show Pattern

> ⚠️ **CRITICAL:** Read `/docs/troubleshooting/CRITICAL_CSS_HIDE_SHOW_FIX.md`

Both Dashboard and Canvas are **always mounted**. CSS toggles visibility:

```typescript
// ✅ CORRECT - Excalidraw always mounted
<div style={{ display: appMode === "dashboard" ? "block" : "none" }}>
  <Dashboard />
</div>
<div style={{ display: appMode === "canvas" ? "block" : "none" }}>
  <Excalidraw />
</div>
```

**Why?** Conditional rendering unmounts Excalidraw, losing all state.

## Localization

**Always add translation keys** to both files:
- `packages/excalidraw/locales/en.json`
- `packages/excalidraw/locales/ru-RU.json`

```typescript
import { t } from "@excalidraw/excalidraw/i18n";
<span>{t("workspace.myProfile")}</span>
```

## Input Fields in Dialogs

**Critical:** Stop keyboard event propagation:

```typescript
<input
  onKeyDown={(e) => e.stopPropagation()}
  onKeyUp={(e) => e.stopPropagation()}
/>
```

## Styling

### Dark Mode Support

```scss
.my-component {
  background: var(--island-bg-color, #fff);
  color: var(--text-primary-color, #1b1b1f);
}

// Use BOTH selectors for workspace components
.excalidraw.theme--dark,
.excalidraw-app.theme--dark {
  .my-component {
    background: var(--island-bg-color, #232329);
  }
}
```

### Components Outside `.excalidraw`

**CRITICAL:** Add `--ui-font` at root of SCSS files:

```scss
.my-new-component {
  --ui-font: Assistant, system-ui, BlinkMacSystemFont, -apple-system, Segoe UI,
    Roboto, Helvetica, Arial, sans-serif;
  font-family: var(--ui-font);
}
```

## Data Fetching (React Query)

Server state (scenes, workspaces, collections) uses React Query:

```typescript
import { useScenesCache } from "../../hooks/useScenesCache";
import { useWorkspaces } from "../../hooks/useWorkspaces";
import { useCollections } from "../../hooks/useCollections";
import { useSceneActions } from "../../hooks/useSceneActions";

// Fetching data
const { scenes, isLoading } = useScenesCache({
  workspaceId,
  collectionId,
  enabled: !!workspaceId,
});

// Scene CRUD with optimistic updates
const { deleteScene, renameScene, duplicateScene, isDeleting } = useSceneActions({
  workspaceId,
  collectionId,
});

// Delete/rename update UI immediately, roll back on error
await deleteScene(sceneId);
await renameScene(sceneId, "New Title");
```

**See:** `/docs/planning/SCENES_CACHE.md` for caching details.

## Client State (Jotai)

UI state shared across components uses Jotai atoms:

```typescript
import { useAtomValue } from "../../app-jotai";
import {
  currentWorkspaceAtom,
  collectionsAtom,
  activeCollectionAtom,
} from "../Settings/settingsState";

// Read workspace selection
const workspace = useAtomValue(currentWorkspaceAtom);
const collections = useAtomValue(collectionsAtom);
const activeCollection = useAtomValue(activeCollectionAtom); // derived
```

**Rule:** React Query for server data, Jotai for client state.

## API Calls

The API client is organized into domain-specific modules in `auth/api/`:

```typescript
// Import from workspaceApi (backward compatible)
import { listScenes, createScene } from "../../auth/workspaceApi";

// Or import from specific modules (preferred for new code)
import { listScenes, createScene } from "../../auth/api/scenes";
import { listWorkspaces } from "../../auth/api/workspaces";
import { listCollections } from "../../auth/api/collections";

// All API calls automatically include credentials for JWT cookies
const scenes = await listScenes();
```

**API Modules:** `scenes.ts`, `workspaces.ts`, `collections.ts`, `teams.ts`, `members.ts`, `invites.ts`, `users.ts`, `talktracks.ts`

## Environment Variables in Docker

**Runtime config via `window.__ENV__`:**

```typescript
function getEnvVar(name: string, defaultValue: string = ""): string {
  if (typeof window !== "undefined" && window.__ENV__?.[name]) {
    return window.__ENV__[name];
  }
  return import.meta.env[name] ?? defaultValue;
}
```

**NEVER duplicate the `Window.__ENV__` type declaration!** It's defined only in `frontend/excalidraw-app/env.ts`.

## Build Commands

```bash
cd frontend
yarn install              # Install dependencies
yarn start                # Development server
yarn test:typecheck       # TypeScript check
yarn test:all             # Run ALL checks
yarn fix                  # Auto-fix formatting

# Run unit tests
yarn test:app             # Watch mode
yarn test:app --run       # Run once
yarn test:app --run excalidraw-app/tests/hooks/  # Specific tests
```

## Testing

Tests are in `excalidraw-app/tests/` using Vitest + React Testing Library.

### Testing Hooks with React Query

```typescript
import { renderHookWithProviders, createMockScenes } from "../testUtils";

// Mock API BEFORE importing the mocked module
vi.mock("../../auth/workspaceApi", () => ({
  listWorkspaceScenes: vi.fn(),
}));

// Import mocked module AFTER vi.mock()
import { listWorkspaceScenes } from "../../auth/workspaceApi";

it("should fetch scenes", async () => {
  const mockScenes = createMockScenes(3);
  (listWorkspaceScenes as ReturnType<typeof vi.fn>).mockResolvedValueOnce(mockScenes);

  const { result } = renderHookWithProviders(() =>
    useScenesCache({ workspaceId: "ws-1" }),
  );

  await waitFor(() => expect(result.current.isLoading).toBe(false));
  expect(result.current.scenes).toEqual(mockScenes);
});
```

**Key patterns:**
- Use `renderHookWithProviders()` for hooks using React Query
- Use `createMockScenes()` / `createMockScene()` for typed mock data
- Mock imports must come AFTER `vi.mock()` calls
- Clear mocks with `vi.clearAllMocks()` in `beforeEach`
