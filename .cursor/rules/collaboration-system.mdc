---
description: "Collaboration system architecture, permissions, and patterns for AstraDraw"
globs:
  - "frontend/excalidraw-app/collab/**"
  - "frontend/excalidraw-app/share/**"
  - "frontend/excalidraw-app/data/httpStorage.ts"
  - "frontend/excalidraw-app/data/workspaceSceneLoader.ts"
  - "frontend/excalidraw-app/components/Workspace/CopyMoveDialog.tsx"
  - "frontend/excalidraw-app/components/Workspace/WorkspaceSidebar.tsx"
  - "backend/src/workspace/**"
  - "backend/src/workspaces/**"
  - "backend/src/collections/**"
  - "backend/src/teams/**"
  - "backend/src/scene-access/**"
  - "room-service/**"
---

# Collaboration System Rules

**Related rules and files:**
- For frontend patterns, see @frontend-patterns
- Full documentation: @docs/features/COLLABORATION.md

## Two Collaboration Modes

| Mode | URL Pattern | Auth Required | Use Case |
|------|-------------|---------------|----------|
| **Workspace Collaboration** | `/workspace/{slug}/scene/{id}#key={roomKey}` | Yes | Team collaboration |
| **Legacy Anonymous** | `/#room={roomId},{roomKey}` | No | Quick sharing |

**Important:** These modes must remain separate. Never mix them.

## Workspace Types

```prisma
enum WorkspaceType {
  PERSONAL  // Auto-created for each user, NO collaboration
  SHARED    // Explicitly created, supports teams & collaboration
}
```

**Key Rule:** Personal workspaces NEVER allow inviting members, creating teams, or collaboration.

## Permission Chain

```
User → WorkspaceMember (role) → TeamMember → Team → TeamCollection (accessLevel) → Collection → Scene
```

### Access Levels

```prisma
enum CollectionAccessLevel {
  VIEW  // Can see scenes, join rooms read-only
  EDIT  // Can edit scenes, full collaboration
}
```

### Scene Access Result

```typescript
interface SceneAccessResult {
  canView: boolean;
  canEdit: boolean;
  canCollaborate: boolean;
}
```

## Key Backend Patterns

### SceneAccessService

Always use `SceneAccessService.checkAccess(sceneId, userId)` before loading/modifying scenes:

```typescript
// CORRECT
const access = await this.sceneAccessService.checkAccess(sceneId, user.id);
if (!access.canView) {
  throw new ForbiddenException('Access denied');
}

// WRONG - Don't check just ownership
if (scene.userId !== user.id) { ... }
```

### Workspace Type Guards

```typescript
async inviteMember(workspaceId: string, ...) {
  const workspace = await this.prisma.workspace.findUnique({ where: { id: workspaceId } });
  
  if (workspace.type === 'PERSONAL') {
    throw new ForbiddenException('Cannot invite members to a personal workspace');
  }
}
```

## Frontend API Integration

**File:** `frontend/excalidraw-app/auth/workspaceApi.ts`

```typescript
// Load scene with permissions via workspace slug
const { scene, data, access } = await getSceneBySlug(workspaceSlug, sceneId);

// Start collaboration (POST)
await startSceneCollaboration(sceneId);

// Get collaboration credentials (GET)
const creds = await getSceneCollaboration(sceneId);
// Returns: { roomId: string, roomKey: string }
```

## URL Detection (App.tsx)

```typescript
// 1. Check for workspace scene URL
const sceneMatch = pathname.match(/^\/workspace\/([^/]+)\/scene\/([^/#]+)/);
if (sceneMatch) { /* Load workspace scene */ }

// 2. Check for legacy room URL
const roomMatch = hash.match(/^#room=([a-zA-Z0-9_-]+),([a-zA-Z0-9_-]+)$/);
if (roomMatch) { /* Load legacy anonymous room */ }

// 3. Default to dashboard/workspace view
```

## Common Mistakes to Avoid

### Backend
1. Don't bypass permission checks - Always use `SceneAccessService`
2. Don't allow collaboration in personal workspaces
3. Don't store room keys unencrypted

### Frontend
4. Don't mix URL patterns - Keep workspace and legacy modes separate
5. Don't auto-join collaboration without checking `access.canCollaborate`
6. Don't show copy/move for personal workspaces

## Related Documentation

- `/docs/features/COLLABORATION.md` - Full system documentation
- `/docs/planning/COLLABORATION_IMPLEMENTATION_PLAN.md` - Implementation details
- `/docs/guides/ROLES_TEAMS_COLLECTIONS.md` - Permission model details
