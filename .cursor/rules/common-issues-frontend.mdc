---
description: "Common frontend issues and solutions for AstraDraw"
globs: ["frontend/**/*.ts", "frontend/**/*.tsx", "frontend/**/*.scss"]
---

# Common Frontend Issues

**Related rules and files:**
- For patterns, see @frontend-patterns
- For CSS hide/show details: @docs/troubleshooting/CRITICAL_CSS_HIDE_SHOW_FIX.md

## 1. Translation Key Errors

**Error:** `Argument of type '"some.key"' is not assignable to parameter of type 'NestedKeyOf<{...}>'`

**Solution:** Add the missing key to locale files:
- `frontend/packages/excalidraw/locales/en.json`
- `frontend/packages/excalidraw/locales/ru-RU.json`

## 2. Input Fields Affecting Canvas

**Problem:** Typing in input fields triggers canvas shortcuts.

**Solution:** Stop event propagation:
```typescript
<input
  onKeyDown={(e) => e.stopPropagation()}
  onKeyUp={(e) => e.stopPropagation()}
/>
```

## 3. Auto-save Status Stuck on "Unsaved Changes"

**Problem:** Save status shows "Unsaved changes" even after successful save.

**Root Cause:** Excalidraw's `onChange` fires continuously for every state change.

**Solution:** Compare serialized scene data before marking as unsaved:

```typescript
const lastSavedDataRef = useRef<string | null>(null);

// In onChange:
const currentData = JSON.stringify({ elements, appState: {...} });
if (lastSavedDataRef.current !== currentData) {
  setHasUnsavedChanges(true);
}

// After save:
lastSavedDataRef.current = dataString;
setHasUnsavedChanges(false);
```

**See:** `/docs/guides/AUTOSAVE.md` for complete details.

## 4. Fonts Look Like Times New Roman

**Problem:** Text in dashboard/workspace appears in serif font.

**Cause:** Components outside `.excalidraw` don't inherit `--ui-font`.

**Solution:** Define `--ui-font` locally:
```scss
.dashboard-view {
  --ui-font: Assistant, system-ui, BlinkMacSystemFont, -apple-system, Segoe UI,
    Roboto, Helvetica, Arial, sans-serif;
  font-family: var(--ui-font);
}
```

## 5. Data Not Updating Across Components

**Problem:** Data created in one component doesn't appear in another.

**Solution:** Use Jotai refresh trigger atoms:

```typescript
// In component that modifies data
const triggerCollectionsRefresh = useSetAtom(triggerCollectionsRefreshAtom);
await createCollection(...);
triggerCollectionsRefresh();

// In component that displays data
const collectionsRefresh = useAtomValue(collectionsRefreshAtom);
useEffect(() => { loadData(); }, [collectionsRefresh]);
```

## 6. ðŸš¨ Infinite Loop in URL Navigation

**Problem:** App crashes with "Maximum call stack size exceeded".

**Cause:** Navigation atoms push URLs â†’ triggers popstate â†’ calls navigation atom again.

**Solution - One-Way URL Flow:**
```typescript
// In handlePopState - set state DIRECTLY:
const handlePopState = () => {
  const route = parseUrl();
  if (route.type === "dashboard") {
    setAppMode("dashboard");    // âœ… Direct state set
    setDashboardView("home");   // âœ… No URL push
  }
};
```

**Rule:** `handlePopState` should NEVER call navigation atoms that push URLs.

## 7. ðŸš¨ Infinite Loop in useEffect

**Problem:** App makes hundreds of API requests per second.

**Cause:** `useEffect` has state variable in deps but also calls setter for that state.

**Solution:** Use a ref to prevent duplicate executions:
```typescript
const hasSetDefaultRef = useRef(false);

useEffect(() => {
  if (!hasSetDefaultRef.current) {
    hasSetDefaultRef.current = true;
    setActiveCollectionId(data.defaultId);
  }
}, [setActiveCollectionId]);
```

## 8. Scene Data Loss When Navigating

> âœ… **SOLVED** - See `/docs/troubleshooting/CRITICAL_CSS_HIDE_SHOW_FIX.md`

**Solution: CSS Hide/Show Pattern** - Both Dashboard and Canvas are always mounted:

```typescript
<div style={{ display: appMode === "dashboard" ? "block" : "none" }}>
  <WorkspaceMainContent />
</div>
<div style={{ display: appMode === "canvas" ? "block" : "none" }}>
  <Excalidraw />
</div>
```

## 9. CSS Hide/Show Broken by `display: flex !important`

**Problem:** Dashboard and canvas show side-by-side.

**Solution:** Use `aria-hidden` attribute:
```scss
.excalidraw-app__dashboard {
  &[aria-hidden="true"] { display: none !important; }
  &[aria-hidden="false"] { display: flex; }
}
```

## 10. Dark Mode Not Working for Workspace Components

**Problem:** Workspace components don't switch to dark mode.

**Solution:** Use BOTH selectors:
```scss
.excalidraw.theme--dark,
.excalidraw-app.theme--dark {
  .my-component { ... }
}
```

## 11. Loading States Should Use Skeletons

**Problem:** Components show empty space while loading.

**Solution:**
```typescript
import { SceneCardSkeletonGrid } from "../Skeletons";

if (isLoading) {
  return <SceneCardSkeletonGrid count={6} />;
}
```

Available: `SceneCardSkeletonGrid`, `CollectionItemSkeletonList`

## Dark Mode Color Reference

| Element | Light | Dark |
|---------|-------|------|
| Primary text | `#1b1b1f` | `#e1e1e1` |
| Secondary text | `#6b6b6b` | `#9b9b9b` |
| Page background | `#fafafa` | `#1e1e24` |
| Card background | `#ffffff` | `#232329` |

**See:** `/docs/guides/WORKSPACE_UI_STYLING.md`
