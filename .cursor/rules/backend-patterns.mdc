---
description: "Backend development patterns for AstraDraw API (NestJS)"
globs: ["backend/**/*.ts", "backend/prisma/**/*"]
---

# Backend Development Patterns

**Related rules and files:**
- For common issues, see @common-issues-backend
- Database schema: @backend/prisma/schema.prisma

## Project Location

Backend code is in `backend/`. It's a NestJS application.

## Key Directories

```
backend/
├── src/
│   ├── auth/                 # Authentication (OIDC, JWT, local)
│   │   ├── auth.controller.ts
│   │   ├── auth.service.ts
│   │   ├── jwt.guard.ts      # NOT jwt-auth.guard.ts!
│   │   └── jwt.strategy.ts
│   ├── users/                # User management
│   ├── workspaces/           # Workspace CRUD, members, invites
│   ├── workspace/            # Scene management (CRUD, data storage)
│   ├── teams/                # Team management
│   ├── collections/          # Collection management
│   ├── comments/             # Comment threads on scenes
│   ├── notifications/        # Notification system
│   ├── talktrack/            # Video recordings
│   ├── storage/              # S3/MinIO storage
│   ├── prisma/               # Database service
│   └── app.module.ts         # Main module
├── prisma/
│   ├── schema.prisma         # Database schema
│   ├── seed.ts               # Development seed data
│   └── migrations/           # Database migrations
```

## Authentication

### JWT Guard Import

**Critical:** The guard file is `jwt.guard.ts`, NOT `jwt-auth.guard.ts`:

```typescript
// CORRECT
import { JwtAuthGuard } from '../auth/jwt.guard';

// WRONG - will cause build failure
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
```

### Protecting Endpoints

```typescript
@Controller('api/v2/users')
export class UsersController {
  @Get('me')
  @UseGuards(JwtAuthGuard)
  async getProfile(@Request() req: any) {
    const userId = req.user.sub;  // User ID from JWT
  }
}
```

## Database (Prisma)

### Key Models

```prisma
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  oidcId       String?  @unique  // For SSO users
  passwordHash String?           // For local auth users
}

model Workspace {
  id    String        @id @default(cuid())
  name  String
  slug  String        @unique
  type  WorkspaceType // PERSONAL or SHARED
}

model WorkspaceMember {
  workspaceId String
  userId      String
  role        WorkspaceRole  // ADMIN, MEMBER, VIEWER
  @@unique([workspaceId, userId])
}

model Scene {
  id           String   @id @default(cuid())
  title        String
  storageKey   String   @unique  // S3 key
  userId       String
  collectionId String?
}
```

For full schema, see `backend/prisma/schema.prisma`.

### Using Prisma

```typescript
@Injectable()
export class UsersService {
  constructor(private readonly prisma: PrismaService) {}

  async findById(id: string) {
    return this.prisma.user.findUnique({ where: { id } });
  }
}
```

## File Uploads

Use `@nestjs/platform-express` with `FileInterceptor`:

```typescript
import { FileInterceptor } from '@nestjs/platform-express';

@Post('me/avatar')
@UseGuards(JwtAuthGuard)
@UseInterceptors(FileInterceptor('avatar', {
  limits: { fileSize: 2 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    if (!file.mimetype.match(/^image\/(jpeg|png|gif|webp)$/)) {
      cb(new BadRequestException('Only images allowed'), false);
    } else {
      cb(null, true);
    }
  },
}))
async uploadAvatar(@UploadedFile() file: Express.Multer.File) {
  // Requires @types/multer in devDependencies!
}
```

**Required dependency:** `@types/multer` in `devDependencies`

## Build & Check Commands

```bash
cd backend
npm install               # Install dependencies
npm run start:dev         # Development with watch
npm run build             # Build (includes TypeScript)
npm run format            # Prettier formatting
npm run lint              # ESLint code quality
npm run prisma:generate   # Generate Prisma client
npm run prisma:migrate:dev # Run migrations (development)

# Or use Justfile from root:
just check-backend        # Build + format + lint
just db-seed              # Seed database with test data
just dev-fresh            # Reset DB + seed + start dev
```

## Development Seed Data

The seed script (`prisma/seed.ts`) creates test data for development:

```bash
just db-seed              # Run seed script
just dev-fresh            # Full reset + seed + start dev
```

### Test Users (password: `Test123!`)

| User | Email | Role in Acme Corp |
|------|-------|-------------------|
| Alice | `alice@test.local` | ADMIN |
| Bob | `bob@test.local` | MEMBER (EDIT Engineering) |
| Carol | `carol@test.local` | MEMBER (EDIT Design) |
| Dave | `dave@test.local` | VIEWER |
| Eve | `eve@test.local` | (not a member) |

See `/docs/development/TEST_USERS.md` for full scenarios.

## Comment System & Mentions

### Mention Format

Frontend stores mentions in comment text as `@[DisplayName](userId)` but sends an array of user IDs:

```typescript
// Frontend sends:
{
  "content": "Hey @[John](abc123def456), check this out!",
  "mentions": ["abc123def456"]
}
```

The `mentions` array contains **user IDs** (cuid format), not usernames or emails.

### Notification Integration

When creating threads or comments with mentions, notifications are triggered automatically:

```typescript
// In CommentsService
if (dto.mentions?.length) {
  await this.notificationsService.createMentionNotifications({
    actorId: userId,
    mentions: dto.mentions,  // Array of user IDs
    threadId: thread.id,
    commentId: comment.id,
    sceneId,
  });
}
```

**Self-mentions are excluded** - if a user mentions themselves, no notification is created.

## Environment Variables & Docker Secrets

All sensitive configuration supports Docker secrets via the `_FILE` suffix pattern.
See `/docs/deployment/DOCKER_SECRETS.md` for complete documentation.

### Using Secrets in Code

```typescript
import { getSecret, getSecretOrThrow } from '../utils/secrets';

// Checks JWT_SECRET_FILE first, then JWT_SECRET
const jwtSecret = getSecret('JWT_SECRET', 'fallback-value');
const password = getSecretOrThrow('POSTGRES_PASSWORD');
```

### Key Environment Variables

| Variable | Description | Supports `_FILE` |
|----------|-------------|------------------|
| `DATABASE_URL` | PostgreSQL connection string | ✅ |
| `JWT_SECRET` | JWT signing secret | ✅ |
| `OIDC_ISSUER_URL` | OIDC provider URL | ✅ |
| `OIDC_CLIENT_SECRET` | OIDC client secret | ✅ |
| `S3_ACCESS_KEY` | S3/MinIO access key | ✅ |
| `S3_SECRET_KEY` | S3/MinIO secret key | ✅ |
