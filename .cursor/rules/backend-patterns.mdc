---
description: "Backend development patterns for AstraDraw API (NestJS)"
alwaysApply: true
---

# Backend Development Patterns

## Project Location

Backend code is in `backend/` (formerly `excalidraw-storage-backend/`). It's a NestJS application.

## Key Directories

```
backend/
├── src/
│   ├── auth/                 # Authentication (OIDC, JWT, local)
│   │   ├── auth.controller.ts
│   │   ├── auth.service.ts
│   │   ├── jwt.guard.ts      # NOT jwt-auth.guard.ts!
│   │   └── jwt.strategy.ts
│   ├── users/                # User management
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.module.ts
│   ├── workspace/            # Scene management
│   │   └── workspace-scenes.controller.ts
│   ├── talktrack/            # Video recordings
│   │   └── scene-talktrack.controller.ts
│   ├── storage/              # S3/MinIO storage
│   │   └── s3-storage.service.ts
│   ├── prisma/               # Database service
│   └── app.module.ts         # Main module
├── prisma/
│   ├── schema.prisma         # Database schema
│   └── migrations/           # Database migrations
```

## Authentication

### JWT Guard Import

**Critical:** The guard file is `jwt.guard.ts`, NOT `jwt-auth.guard.ts`:

```typescript
// CORRECT
import { JwtAuthGuard } from '../auth/jwt.guard';

// WRONG - will cause build failure
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
```

### Protecting Endpoints

```typescript
@Controller('api/v2/users')
export class UsersController {
  @Get('me')
  @UseGuards(JwtAuthGuard)
  async getProfile(@Request() req: any) {
    const userId = req.user.sub;  // User ID from JWT
    // ...
  }
}
```

## Database (Prisma)

### Schema Location

`backend/prisma/schema.prisma`

### Key Models

```prisma
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  avatarUrl    String?
  oidcId       String?  @unique  // For SSO users
  passwordHash String?           // For local auth users
  scenes       Scene[]
  talktrackRecordings TalktrackRecording[]
}

model Scene {
  id           String   @id @default(cuid())
  title        String
  storageKey   String   @unique  // S3 key
  userId       String
  user         User     @relation(...)
  talktrackRecordings TalktrackRecording[]
}

model TalktrackRecording {
  id               String @id @default(cuid())
  title            String
  kinescopeVideoId String @unique
  sceneId          String
  userId           String
}
```

### Using Prisma

```typescript
@Injectable()
export class UsersService {
  constructor(private readonly prisma: PrismaService) {}

  async findById(id: string) {
    return this.prisma.user.findUnique({ where: { id } });
  }
}
```

## File Uploads

Use `@nestjs/platform-express` with `FileInterceptor`:

```typescript
import { FileInterceptor } from '@nestjs/platform-express';

@Post('me/avatar')
@UseGuards(JwtAuthGuard)
@UseInterceptors(FileInterceptor('avatar', {
  limits: { fileSize: 2 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    if (!file.mimetype.match(/^image\/(jpeg|png|gif|webp)$/)) {
      cb(new BadRequestException('Only images allowed'), false);
    } else {
      cb(null, true);
    }
  },
}))
async uploadAvatar(@UploadedFile() file: Express.Multer.File) {
  // Requires @types/multer in devDependencies!
}
```

**Required dependency:** `@types/multer` in `devDependencies`

## Build & Check Commands

```bash
cd backend
npm install               # Install dependencies
npm run start:dev         # Development with watch

# Required checks before release:
npm run build             # Build (includes TypeScript)
npm run format            # Prettier formatting
npm run lint              # ESLint code quality
npm run test              # Jest unit tests

# Prisma commands:
npm run prisma:generate   # Generate Prisma client
npm run prisma:migrate    # Run migrations (production)
npm run prisma:migrate:dev # Run migrations (development)
npm run prisma:studio     # Open Prisma Studio GUI
```

## Environment Variables & Docker Secrets

All sensitive configuration supports Docker secrets via the `_FILE` suffix pattern.
See `/docs/DOCKER_SECRETS.md` for complete documentation.

### Using Secrets in Code

**Always use `getSecret()` for sensitive configuration:**

```typescript
import { getSecret } from '../utils/secrets';

// Checks JWT_SECRET_FILE first, then JWT_SECRET, then uses fallback
const jwtSecret = getSecret('JWT_SECRET', 'fallback-value');

// For required secrets, use getSecretOrThrow
import { getSecretOrThrow } from '../utils/secrets';
const password = getSecretOrThrow('POSTGRES_PASSWORD');
```

### Key Environment Variables

| Variable | Description | Supports `_FILE` |
|----------|-------------|------------------|
| `DATABASE_URL` | PostgreSQL connection string | ✅ |
| `POSTGRES_USER` | Database username | ✅ |
| `POSTGRES_PASSWORD` | Database password | ✅ |
| `POSTGRES_DB` | Database name | ✅ |
| `POSTGRES_HOST` | Database host | ❌ |
| `POSTGRES_PORT` | Database port | ❌ |
| `JWT_SECRET` | JWT signing secret | ✅ |
| `OIDC_ISSUER_URL` | OIDC provider URL | ✅ |
| `OIDC_CLIENT_ID` | OIDC client ID | ✅ |
| `OIDC_CLIENT_SECRET` | OIDC client secret | ✅ |
| `OIDC_INTERNAL_URL` | Internal OIDC URL (Docker) | ✅ |
| `ADMIN_PASSWORD` | Default admin password | ✅ |
| `SUPERADMIN_EMAILS` | Super admin emails | ✅ |
| `KINESCOPE_API_KEY` | Video hosting API key | ✅ |
| `KINESCOPE_PROJECT_ID` | Video hosting project | ✅ |
| `S3_ACCESS_KEY` | S3/MinIO access key | ✅ |
| `S3_SECRET_KEY` | S3/MinIO secret key | ✅ |

### External PostgreSQL

To use an external PostgreSQL server:

```bash
# In deploy/.env
POSTGRES_HOST=10.1.125.55
POSTGRES_PORT=5000

# Create secrets
echo "db_user" > deploy/secrets/postgres_user
echo "db_password" > deploy/secrets/postgres_password
echo "db_name" > deploy/secrets/postgres_db

# Start without built-in postgres
docker compose up -d --scale postgres=0
```

