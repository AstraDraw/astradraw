---
description: "Docker deployment patterns for AstraDraw"
globs: ["deploy/**/*", "docker-compose*.yml", "Dockerfile", "**/Dockerfile"]
---

# Docker Deployment Patterns

**Key files for context:**
@deploy/docker-compose.yml

## Deploy Folder Structure

All deployment files are in `deploy/`:

```
deploy/
├── docker-compose.yml              # Main config (GHCR images)
├── docker-compose.override.yml     # Local builds (gitignored)
├── .env                            # Environment variables (gitignored)
├── env.example                     # Environment template
├── dex-config.yaml                 # OIDC test provider config
├── traefik-dynamic.yml             # Traefik TLS config
├── certs/                          # SSL certificates (gitignored)
├── secrets/                        # Docker secrets (gitignored)
└── libraries/                      # Excalidraw shape libraries
```

> **See also:** `/docs/deployment/DOCKER_SECRETS.md` for complete secrets documentation.

## Running the Application

```bash
cd deploy

# Copy and configure environment
cp env.example .env

# Start with production images
docker compose up -d

# Start with local builds
cp docker-compose.override.yml.disabled docker-compose.override.yml
docker compose up -d --build

# View logs
docker compose logs -f api
```

## Services

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| traefik | traefik:v3.0 | 80, 443 | Reverse proxy |
| app | ghcr.io/astrateam-net/astradraw-app | 80 | Frontend |
| api | ghcr.io/astrateam-net/astradraw-api | 8080 | Backend API |
| room | ghcr.io/astrateam-net/astradraw-room | 80 | WebSocket |
| postgres | postgres:16-alpine | 5432 | Database |
| minio | minio/minio | 9000/9001 | Object storage |

## Image Versioning

When releasing new versions:

1. Update `CHANGELOG.md` in the respective repo
2. Tag and push:
   ```bash
   cd frontend && git tag v0.18.0-beta0.XX && git push origin main --tags
   cd backend && git tag v0.5.X && git push origin main --tags
   ```
3. Update `deploy/docker-compose.yml` with new image versions

## Environment Variables

Key variables in `deploy/.env`:

```bash
APP_DOMAIN=localhost
APP_PROTOCOL=https
POSTGRES_USER=excalidraw
POSTGRES_PASSWORD=<secure>
POSTGRES_DB=excalidraw

# Optional OIDC
OIDC_ISSUER_URL=https://auth.example.com/...
OIDC_CLIENT_ID=astradraw
OIDC_CLIENT_SECRET=<secret>
OIDC_INTERNAL_URL=http://dex:5556/dex  # For Docker networking
```

## Creating Secrets

```bash
cd deploy && mkdir -p secrets

# Database credentials
echo "excalidraw" > secrets/postgres_user
openssl rand -base64 32 > secrets/postgres_password
echo "excalidraw" > secrets/postgres_db

# JWT secret (required)
openssl rand -base64 32 > secrets/jwt_secret

# MinIO credentials
echo "minioadmin" > secrets/minio_access_key
openssl rand -base64 32 > secrets/minio_secret_key
```

## Fresh Start

To reset all data:

```bash
cd deploy
docker compose down -v
docker volume rm astradraw_postgres_data astradraw_minio_data
docker compose up -d
```
