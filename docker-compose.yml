# Astradraw - Self-hosted Excalidraw with Collaboration
# 
# This docker-compose file sets up:
# - Excalidraw frontend (built from source)
# - Excalidraw room server (WebSocket for collaboration)
# - Storage backend (HTTP API for persistence)
# - MinIO (S3-compatible object storage) OR PostgreSQL (via Keyv)
# - Traefik proxy (for single-domain routing)
#
# Storage Options:
#   - S3/MinIO (default): Set STORAGE_BACKEND=s3 (recommended for blobs)
#   - Keyv/PostgreSQL: Set STORAGE_BACKEND=keyv (legacy, for small deployments)
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Create secrets: see secrets/ directory
#   3. Run: docker-compose up -d --build

services:
  # Traefik reverse proxy
  traefik:
    image: traefik:v3.0
    command:
      - "--api.dashboard=true"
      # Uncomment for debugging:
      # - "--api.insecure=true"
      # - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Uncomment for automatic HTTPS with Let's Encrypt
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      # Uncomment for Traefik dashboard:
      # - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/traefik/certs:ro
      - ./traefik-dynamic.yml:/etc/traefik/dynamic/config.yml:ro
      # - ./letsencrypt:/letsencrypt
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # Dashboard (optional, uncomment to enable)
      # - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${APP_DOMAIN}`)"
      # - "traefik.http.routers.traefik-dashboard.service=api@internal"

  # Excalidraw Frontend
  app:
    # For local development: clone astradraw-app and build from source
    # build:
    #   context: ./astradraw-app
    #   dockerfile: Dockerfile
    # For production: use pre-built image from GitHub Container Registry
    image: ghcr.io/astrateam-net/astradraw-app:latest
    # Uncomment below to build from local source during development
    # build:
    #   context: ./excalidraw
    #   dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Use http:// for local testing, https:// for production with SSL
      - VITE_APP_WS_SERVER_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}
      - VITE_APP_BACKEND_V2_GET_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2/scenes/
      - VITE_APP_BACKEND_V2_POST_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2/scenes/
      - VITE_APP_STORAGE_BACKEND=http
      - VITE_APP_HTTP_STORAGE_BACKEND_URL=${APP_PROTOCOL:-http}://${APP_DOMAIN}/api/v2
      - VITE_APP_FIREBASE_CONFIG=
      - VITE_APP_DISABLE_TRACKING=true
      # GIPHY API key for Stickers & GIFs sidebar (get one at https://developers.giphy.com/)
      - VITE_APP_GIPHY_API_KEY=${GIPHY_API_KEY:-}
      # Kinescope configuration for Talktrack recordings (get keys at https://app.kinescope.io/)
      - VITE_APP_KINESCOPE_API_KEY=${KINESCOPE_API_KEY:-}
      - VITE_APP_KINESCOPE_PROJECT_ID=${KINESCOPE_PROJECT_ID:-}
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # HTTP (redirect to HTTPS)
      - "traefik.http.routers.excalidraw-app.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.excalidraw-app.entrypoints=web"
      - "traefik.http.routers.excalidraw-app.middlewares=redirect-to-https"
      # HTTPS
      - "traefik.http.routers.excalidraw-app-secure.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.excalidraw-app-secure.entrypoints=websecure"
      - "traefik.http.routers.excalidraw-app-secure.tls=true"
      - "traefik.http.services.excalidraw-app.loadbalancer.server.port=80"
      # Redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.excalidraw-app.priority=1"
      - "traefik.http.routers.excalidraw-app-secure.priority=1"
    depends_on:
      - storage
      - room

  # Excalidraw Room Server (WebSocket collaboration)
  room:
    # Using upstream excalidraw-room with Node 18
    image: excalidraw/excalidraw-room:latest
    # Uncomment below to build from local source during development
    # build:
    #   context: ./excalidraw-room
    #   dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - PORT=80
      - CORS_ORIGIN=*
      - DEBUG=*
    networks:
      - astradraw
    labels:
      - "traefik.enable=true"
      # WebSocket routing via /socket.io/ path (HTTPS)
      - "traefik.http.routers.excalidraw-room-secure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.excalidraw-room-secure.entrypoints=websecure"
      - "traefik.http.routers.excalidraw-room-secure.tls=true"
      - "traefik.http.routers.excalidraw-room-secure.priority=100"
      - "traefik.http.services.excalidraw-room.loadbalancer.server.port=80"
      # WebSocket routing via /socket.io/ path (HTTP -> HTTPS)
      - "traefik.http.routers.excalidraw-room.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.excalidraw-room.entrypoints=web"
      - "traefik.http.routers.excalidraw-room.middlewares=redirect-to-https"
      - "traefik.http.routers.excalidraw-room.priority=100"

  # Storage Backend (HTTP API for scenes/files)
  storage:
    # For production: use pre-built image from GitHub Container Registry
    image: ghcr.io/astrateam-net/astradraw-storage:0.2
    # Uncomment below to build from local source during development
    # build:
    #   context: ./excalidraw-storage-backend
    #   dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # Storage backend selection: 's3' (MinIO/S3) or 'keyv' (PostgreSQL/MongoDB)
      - STORAGE_BACKEND=${STORAGE_BACKEND:-s3}
      
      # === S3/MinIO Configuration (when STORAGE_BACKEND=s3) ===
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY_FILE=/run/secrets/minio_access_key
      - S3_SECRET_KEY_FILE=/run/secrets/minio_secret_key
      - S3_BUCKET=${S3_BUCKET:-excalidraw}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_FORCE_PATH_STYLE=true
      
      # === Keyv Configuration (when STORAGE_BACKEND=keyv) ===
      # - STORAGE_URI_FILE=/run/secrets/storage_uri
      # - STORAGE_URI=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      
      # === Kinescope Configuration (for Talktrack video proxy) ===
      - KINESCOPE_API_KEY=${KINESCOPE_API_KEY:-}
      - KINESCOPE_PROJECT_ID=${KINESCOPE_PROJECT_ID:-}
      
      - PORT=8080
      - LOG_LEVEL=log  # Set to 'log' to see secret loading messages
    volumes:
      - ./secrets:/run/secrets:ro
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      # API routing via /api/v2/ path (HTTPS)
      - "traefik.http.routers.excalidraw-storage-secure.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/v2`)"
      - "traefik.http.routers.excalidraw-storage-secure.entrypoints=websecure"
      - "traefik.http.routers.excalidraw-storage-secure.tls=true"
      - "traefik.http.routers.excalidraw-storage-secure.priority=100"
      - "traefik.http.services.excalidraw-storage.loadbalancer.server.port=8080"
      # API routing via /api/v2/ path (HTTP -> HTTPS)
      - "traefik.http.routers.excalidraw-storage.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/v2`)"
      - "traefik.http.routers.excalidraw-storage.entrypoints=web"
      - "traefik.http.routers.excalidraw-storage.middlewares=redirect-to-https"
      - "traefik.http.routers.excalidraw-storage.priority=100"
      # Note: Don't strip prefix - storage backend already expects /api/v2 routes
    depends_on:
      minio:
        condition: service_healthy

  # MinIO - S3-compatible Object Storage (recommended for blob storage)
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      - MINIO_ROOT_USER_FILE=/run/secrets/minio_access_key
      - MINIO_ROOT_PASSWORD_FILE=/run/secrets/minio_secret_key
    volumes:
      - minio_data:/data
      - ./secrets:/run/secrets:ro
    networks:
      - internal
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Console (Object Storage Admin UI - Optional)
  minio-console:
    image: minio/minio:latest
    entrypoint: [""]
    command: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-console-secure.rule=Host(`s3.${APP_DOMAIN}`)"
      - "traefik.http.routers.minio-console-secure.entrypoints=websecure"
      - "traefik.http.routers.minio-console-secure.tls=true"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      - "traefik.http.routers.minio-console-secure.service=minio-console-backend"
      - "traefik.http.services.minio-console-backend.loadbalancer.server.url=http://minio:9001"
    depends_on:
      - minio
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

  # PostgreSQL Database (recommended for production)
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    labels:
      - "traefik.enable=false"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin (Database Admin UI - Optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
      - PGADMIN_CONFIG_SERVER_MODE=False
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - astradraw
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin-secure.rule=Host(`db.${APP_DOMAIN}`)"
      - "traefik.http.routers.pgadmin-secure.entrypoints=websecure"
      - "traefik.http.routers.pgadmin-secure.tls=true"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
    depends_on:
      - postgres
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

networks:
  astradraw:
    driver: bridge
  internal:
    driver: bridge
    internal: true

volumes:
  postgres_data:
  pgadmin_data:
  minio_data:

